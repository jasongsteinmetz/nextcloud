services:
  nextcloud:
    image: nextcloud
    container_name: nextcloud
    restart: unless-stopped
    networks: 
      proxy:
        ipv4_address: 172.21.0.50
      default:
    depends_on:
      - nextclouddb
      - redis
      - harp
    volumes:
      # BIND MOUNTS (Absolute Paths)
      - /var/lib/docker_data/nextcloud/html:/var/www/html
      - /var/lib/docker_data/nextcloud/custom_apps:/var/www/html/custom_apps
      - /var/lib/docker_data/nextcloud/config:/var/www/html/config
      # MEDIA (Large storage)
      - /data/nextcloud:/var/www/html/data
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=${NEXTCLOUD_MYSQL_PW}
      - MYSQL_HOST=nextclouddb
      - REDIS_HOST=redis

  nextclouddb:
    image: mariadb
    container_name: nextcloud-db
    restart: unless-stopped
    # Fix for io_uring crashes on Ubuntu 22.04
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW --innodb-use-native-aio=0
    volumes:
      - /var/lib/docker_data/nextcloud/db:/var/lib/mysql
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_PASSWORD=${NEXTCLOUD_MYSQL_PW}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MARIADB_AUTO_UPGRADE=1 # Ensures future updates run smoothly

  collabora:
    image: collabora/code
    container_name: collabora
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - password=${COLLABORA_PW}
      - username=nextcloud
      - domain=cloud.streametz.com
      - extra_params=--o:ssl.enable=true

  redis:
    image: redis:alpine
    container_name: redis
    volumes:
      - /var/lib/docker_data/nextcloud/redis:/data  

  harp:
    image: ghcr.io/nextcloud/nextcloud-appapi-harp:release
    container_name: appapi-harp
    restart: unless-stopped
    networks: 
      proxy:
        ipv4_address: 172.21.0.51
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker_data/nextcloud/certs:/certs
    environment:
      - PUID=1000
      - PGID=1000
      - HP_SHARED_KEY=${HARP_SHARED_KEY}
      - NC_INSTANCE_URL=http://nextcloud
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]

  talk:
    image: ghcr.io/nextcloud-releases/aio-talk:latest
    container_name: talk-hpb
    restart: unless-stopped
    networks: 
      proxy:
        ipv4_address: 172.21.0.52
    init: true
    ports:
      - 3478:3478/tcp
      - 3478:3478/udp
    environment:
      - NC_DOMAIN=cloud.streametz.com
      - TALK_HOST=cloud.streametz.com
      - TURN_SECRET=${TALK_TURN_SECRET}
      - SIGNALING_SECRET=${TALK_SIGNALING_SECRET}
      - INTERNAL_SECRET=${TALK_INTERNAL_SECRET}
      - TZ=America/New_York
      - TALK_PORT=3478

networks:
  proxy:
    external: true
